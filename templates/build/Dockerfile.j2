FROM {{ base_img }}

# Add some labels
LABEL maintainer="{{ img_maintainer }}"
LABEL description="{{ img_description }}"
LABEL com.mesoform.baseimage={{ is_base_image }}
LABEL com.joyent.autopilotpattern={{ on_autopilot }}
LABEL com.mesoform.builddate="{{ date }}"
LABEL com.mesoform.baseimage.ver="{{ base_img }}"
LABEL com.docker.img.ver="{{ img_name }}:{{ img_ver }}"
{% if labels is defined %}
{% for label in labels %}
LABEL {{ label }}
{% endfor %}
{% endif %}

# Set some environment variables
ENV DOCKER_IMG_VER="{{ img_name }}:{{ img_ver }}"
ENV DNS_DOMAIN={{ dns_domain }}
ENV CONSUL_AGENT={{ consul_as_agent }}
ENV CONSUL_VERSION={{ consul_version }}
ENV CONSUL_CHECKSUM={{ consul_checksum }}
{% if env_vars is defined %}
{% for env in env_vars %}
ENV {{ env }}
{% endfor %}
{% endif %}

{% if build_args is defined %}
# Set some build arguments
{% for arg in build_args %}
ARG {{ arg }}
{% endfor %}
{% endif %}


{% if install_script is defined %}
# If we have an install script, run it.
RUN chmod -R +x {{ install_script }}
RUN {{ install_script }}
{% endif %}

{% if volumes is defined %}
# define volumes if set
VOLUME [ {% for volume in volumes %}"{{ volume }}" {% endfor %} ]
{% endif %}

{% if work_dir is defined %}
# Set application working directory.
WORKDIR {{ work_dir }}
{% endif %}

{% if ports is defined %}
# We don't need to expose these ports in order for other containers on Triton
# to reach this container in the default networking environment, but if we
# leave this here then we get the ports as well-known environment variables
# for purposes of linking.
EXPOSE {% for port in ports %}{{ port }} {% endfor %}
{% endif %}


{% if is_base_image == true %}
# true should be lowercase http://jinja.pocoo.org/docs/2.9/templates/
COPY etc /etc/
COPY bin /usr/local/bin/
RUN chmod -R +x /usr/local/bin/
ONBUILD COPY etc /etc/
ONBUILD COPY bin /usr/local/bin/
{% endif %}


{% if entrypoint is defined %}
# Generally for creating base images. Otherwise entrypoint should already be set to containerpilot
ENTRYPOINT [ {{ entrypoint }} ]
{% endif %}
